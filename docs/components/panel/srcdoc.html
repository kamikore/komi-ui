<!doctype html>
	<head>
		<style id="__sfc-styles"></style>
		<script>
			(() => {
				let scriptEls = []

				// 用于挂载模块
				window.__modules__ = {}

				async function handle_message(ev) {
					console.log("消息处理: ",ev)
					if (event.origin !== "http://localhost:5173")
						return

					let { action, cmd_id } = ev.data;
					const send_reply = (payload) => parent.postMessage( { ...payload }, ev.origin);

					if (action === 'eval') {
						try {
							if (scriptEls.length) {
								scriptEls.forEach(el => {
									document.head.removeChild(el)
								})
								scriptEls.length = 0
							}

							let { scripts } = ev.data
							if (typeof scripts === 'string') scripts = [scripts]

							for (const script of scripts) {
								const scriptEl = document.createElement('script')
								scriptEl.setAttribute('type', 'module')
								// 确保模块添加顺序
								const done = new Promise((resolve) => {
									window.__next__ = resolve
								})

								scriptEl.innerHTML = script + `\nwindow.__next__()`

								document.head.appendChild(scriptEl)
								scriptEl.onerror = err => send_error(err.message, err.stack)
								scriptEls.push(scriptEl)
								await done
							}
						} catch (error) {
							console.error("创建script错误",error);
						}
					}
				}

				// 监听接收的 message
				window.addEventListener('message', handle_message, false);
			})()
		</script>

		<!-- ES Module Shims: Import maps polyfill for modules browsers without import maps support (all except Chrome 89+) -->
		<script async src="https://unpkg.com/es-module-shims@1.5.18/dist/es-module-shims.wasm.js"></script>
		<script type="importmap"><!--IMPORT_MAP--></script>
	</head>
	<body></body>
</html>
